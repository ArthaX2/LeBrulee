{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
.checkout-wrapper {
    max-width: 1100px;
    margin: 4rem auto;
    padding: 2rem;
}
.checkout-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}
.panel {
    background: white;
    border-radius: 18px;
    padding: 2rem;
    box-shadow: 0 20px 45px rgba(10, 21, 48, 0.08);
    border: 1px solid #f2f2f2;
}
.panel h2 {
    font-size: 1.5rem;
    color: #0a1530;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
}
.form-input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid #d7d7d7;
    margin-top: 6px;
    margin-bottom: 18px;
    transition: border-color 0.2s ease;
}
.form-input:focus {
    border-color: #fbbf24;
    outline: none;
    box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.25);
}
.place-order-btn {
    width: 100%;
    background: linear-gradient(135deg, #0a1530, #152857);
    color: #fbbf24;
    padding: 1rem 1.2rem;
    font-size: 1.1rem;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.place-order-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(10, 21, 48, 0.35);
}
.summary-section {
    background: linear-gradient(135deg, #fff8ec, #fef3d7);
    border-radius: 18px;
    padding: 2rem;
    border: 1px solid #fde8bc;
}
.summary-section ul li {
    padding: 0.7rem 0;
    border-bottom: 1px dashed rgba(10,21,48,0.1);
}
.success-banner {
    background: linear-gradient(120deg, #0a1530, #182a5b);
    color: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    box-shadow: 0 25px 50px rgba(10, 21, 48, 0.4);
}
.success-banner .status-pill {
    background: rgba(255, 255, 255, 0.15);
    padding: 0.4rem 1rem;
    border-radius: 999px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.eta-card {
    background: white;
    color: #0a1530;
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    min-width: 220px;
    box-shadow: inset 0 0 0 1px rgba(10, 21, 48, 0.08);
}
.eta-card span {
    display: block;
}
.eta-title {
    font-size: 0.85rem;
    color: #58607a;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.eta-time {
    font-size: 1.9rem;
    font-weight: 700;
}
.eta-sub {
    font-size: 0.95rem;
    color: #888fa8;
}
.delivery-control {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}
.delivery-control button {
    border: none;
    border-radius: 12px;
    padding: 0.9rem 1.4rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.delivery-control .status-btn {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}
.delivery-control .status-btn.delivered {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
    border-color: rgba(34, 197, 94, 0.4);
}
.delivery-control .status-btn.cancelled {
    background: rgba(248, 113, 113, 0.15);
    color: #b91c1c;
    border-color: rgba(248, 113, 113, 0.4);
}
.delivery-control .done-btn {
    background: #fbbf24;
    color: #0a1530;
}
.delivery-control button:hover {
    transform: translateY(-1px);
}
.history-section {
    margin-top: 3rem;
}
.history-section table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    overflow: hidden;
    border-radius: 18px;
    box-shadow: 0 12px 30px rgba(10, 21, 48, 0.08);
}
.history-section th,
.history-section td {
    padding: 1rem;
    text-align: left;
    background: white;
}
.history-section th {
    background: #0a1530;
    color: #fbbf24;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem;
}
.history-section tr + tr td {
    border-top: 1px solid #f0f0f0;
}
.status-chip {
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
}
.status-chip.preparing {
    background: rgba(14, 116, 144, 0.12);
    color: #0e7490;
}
.status-chip.delivered {
    background: rgba(34, 197, 94, 0.12);
    color: #15803d;
}
.status-chip.cancelled {
    background: rgba(248, 113, 113, 0.12);
    color: #b91c1c;
}
.empty-state {
    text-align: center;
    padding: 3rem;
    border: 2px dashed #e5e7eb;
    border-radius: 16px;
    color: #6b7280;
}
.empty-state a {
    color: #0a1530;
    font-weight: 600;
    text-decoration: underline;
}
.toast {
    position: fixed;
    top: 80px;
    right: 20px;
    background: #0a1530;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 1200;
}
</style>
{% endblock %}

{% block content %}
<div class="checkout-wrapper">
    <h1 class="text-4xl font-bold text-[#0a1530] font-['Playfair_Display'] mb-6">Secure Checkout</h1>

    {% if recent_order %}
    <div class="success-banner" data-order-id="{{ recent_order.id }}">
        <div>
            <div class="status-pill">Payment Successful</div>
            <h2 class="text-3xl font-semibold mt-2 mb-2">Thank you, {{ recent_order.customer }}!</h2>
            <p class="text-gray-200 mb-4">Your order is being prepared. We'll keep you posted.</p>
            <div class="delivery-control">
                <button type="button" class="status-btn" id="delivery-status-btn">
                    <i class="fas fa-truck mr-2"></i>
                    <span id="delivery-status-label">{{ recent_order.status }}</span>
                </button>
                <button type="button" class="done-btn" id="mark-delivered-btn">
                    Done
                </button>
                <button type="button" class="status-btn" id="cancel-order-btn">
                    Cancel Order
                </button>
            </div>
        </div>
        <div class="eta-card">
            <span class="eta-title">Estimated Delivery</span>
            <span class="eta-time">{{ recent_order.delivery_eta }}</span>
            <span class="eta-sub">In about {{ recent_order.delivery_minutes }} mins</span>
        </div>
    </div>
    {% endif %}

    <div class="checkout-container">
        {% if cart_items %}
        <div class="panel">
            <h2><i class="fas fa-map-marker-alt"></i> Shipping Details</h2>
            <form id="checkout-form" action="{{ url_for('main.checkout') }}" method="POST">
                <label for="name" class="block font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" name="name" class="form-input" required>

                <label for="email" class="block font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" name="email" class="form-input" required>

                <label for="address" class="block font-medium text-gray-700">Shipping Address</label>
                <textarea id="address" name="address" class="form-input" rows="3" required></textarea>

                <h2><i class="fas fa-wallet"></i> Payment</h2>

                <div class="flex flex-col space-y-3 mb-4" id="payment-options">
                    <label class="flex items-center space-x-2">
                        <input type="radio" id="cod" name="payment_method" value="cod">
                        <span>Cash on Delivery (COD)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" id="transfer" name="payment_method" value="transfer">
                        <span>Bank Transfer</span>
                    </label>
                </div>

                <div id="cod-details" class="mb-4" style="display: none;">
                    <p class="text-sm text-gray-600 mb-2">
                        Pembayaran dilakukan saat pesanan tiba. Pastikan alamat dan nomor HP bisa dihubungi.
                    </p>
                    <label for="cod_address" class="block font-medium text-gray-700">
                        Alamat COD (opsional, kalau beda dari Shipping Address)
                    </label>
                    <textarea id="cod_address" name="cod_address" class="form-input" rows="2"
                              placeholder="Contoh: gerbang komplek, patokan, dll."></textarea>
                </div>

                <div id="transfer-details" class="mb-4" style="display: none;">
                    <p class="text-sm text-gray-600 mb-2">
                        Silakan transfer ke rekening berikut setelah melakukan pemesanan:
                    </p>
                    <div class="bg-white border border-dashed border-gray-300 rounded-lg p-3 mb-3">
                        <p class="font-semibold text-gray-800">Bank BCA</p>
                        <p class="text-gray-700">a.n. Le Brulee Bakery</p>
                        <p class="text-gray-900 font-bold tracking-wide">1234567890</p>
                    </div>

                    <label for="transfer_sender" class="block font-medium text-gray-700">
                        Nama Pengirim (opsional)
                    </label>
                    <input type="text" id="transfer_sender" name="transfer_sender" class="form-input"
                           placeholder="Nama pemilik rekening / e-wallet">
                </div>

                <button type="submit" class="place-order-btn mt-6">
                    Place Order - ${{ "%.2f"|format(total_amount) }}
                </button>

            </form>
        </div>

        <div class="summary-section">
            <h2 class="text-2xl font-bold text-[#0a1530] mb-4 border-b pb-2">Order Summary</h2>
            <ul class="space-y-3 mb-6">
                {% for item in cart_items %}
                <li class="flex justify-between text-gray-600 border-b border-dashed pb-2">
                    <span class="font-medium">{{ item.quantity }}x {{ item.name }}</span>
                    <span>${{ "%.2f"|format(item.price * item.quantity) }}</span>
                </li>
                {% endfor %}
            </ul>

            <div class="space-y-2 pt-4 border-t">
                <div class="flex justify-between font-medium text-lg">
                    <span>Subtotal:</span>
                    <span>${{ "%.2f"|format(total_amount) }}</span>
                </div>
                <div class="flex justify-between font-medium text-lg">
                    <span>Shipping:</span>
                    <span>$5.00</span>
                </div>
                <div class="flex justify-between font-extrabold text-2xl text-[#0a1530]">
                    <span>Order Total:</span>
                    <span class="text-[#fbbf24]">${{ "%.2f"|format(total_amount + 5.00) }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="panel empty-state">
            {% if recent_order %}
                <p class="text-xl mb-3">Your order is on its way! Add more treats anytime.</p>
            {% else %}
                <p class="text-xl mb-3">Your cart is empty. Add items to proceed with checkout.</p>
            {% endif %}
            <a href="{{ url_for('main.menu') }}">Go back to menu</a>
        </div>
        {% endif %}
    </div>

    <div class="history-section">
        <h2 class="text-2xl font-bold text-[#0a1530]">Payment History</h2>
        {% if order_history %}
        <table>
            <thead>
                <tr>
                    <th>Order</th>
                    <th>Placed</th>
                    <th>Payment</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for order in order_history %}
                <tr data-order-id="{{ order.id }}">
                    <td>#{{ "%04d"|format(order.id) }}</td>
                    <td>{{ order.placed_at }}</td>
                    <td>{{ order.payment_method }}</td>
                    <td>${{ "%.2f"|format(order.total) }}</td>
                    <td>
                        <span class="status-chip {{ order.status|lower }}">
                            {{ order.status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="panel empty-state mt-4">
            <p>No payments yet. Your future orders will appear here.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Checkout form confirmation modal
        const checkoutForm = document.getElementById('checkout-form');
        const placeOrderBtn = document.querySelector('.place-order-btn');

        if (placeOrderBtn && checkoutForm) {
            placeOrderBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();

                // Create modal overlay
                const modal = document.createElement('div');
                modal.id = 'confirm-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:1rem;';

                modal.innerHTML = `
                    <div style="background:white;padding:1.5rem;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,0.25);width:100%;max-width:350px;text-align:center;">
                        <p style="font-size:1.25rem;font-weight:600;margin-bottom:1.5rem;color:#0a1530;">Confirm Order</p>
                        <p style="margin-bottom:1.5rem;color:#374151;">Are you sure you want to place this order?</p>
                        <div style="display:flex;justify-content:center;gap:1rem;">
                            <button type="button" id="modal-cancel" style="padding:0.5rem 1.25rem;background:#d1d5db;border:none;border-radius:8px;cursor:pointer;font-weight:500;">Cancel</button>
                            <button type="button" id="modal-confirm" style="padding:0.5rem 1.25rem;background:#0a1530;color:#fbbf24;border:none;border-radius:8px;cursor:pointer;font-weight:700;">Confirm</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('modal-cancel').onclick = function() {
                    modal.remove();
                };

                document.getElementById('modal-confirm').onclick = function() {
                    modal.remove();
                    checkoutForm.submit();
                };
            });
        }
        const codDetails = document.getElementById('cod-details');
        const transferDetails = document.getElementById('transfer-details');
        const paymentRadios = document.querySelectorAll('input[name="payment_method"]');

        function setPaymentDetails(method) {
            if (!codDetails || !transferDetails) return;
            const showCod = method === 'cod';
            const showTransfer = method === 'transfer';
            codDetails.style.display = showCod ? 'block' : 'none';
            transferDetails.style.display = showTransfer ? 'block' : 'none';
        }

        paymentRadios.forEach((radio) => {
            radio.addEventListener('change', (event) => {
                setPaymentDetails(event.target.value);
            });
        });

        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        setPaymentDetails(selectedMethod ? selectedMethod.value : null);

        const orderBanner = document.querySelector('.success-banner');
        const doneBtn = document.getElementById('mark-delivered-btn');
        const statusLabel = document.getElementById('delivery-status-label');
        const statusBtn = document.getElementById('delivery-status-btn');
        const cancelBtn = document.getElementById('cancel-order-btn');

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            });
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 2600);
        }

        function updateHistoryChip(orderId, statusText) {
            const historyChip = document.querySelector(`.history-section tr[data-order-id="${orderId}"] .status-chip`);
            if (!historyChip) return;
            historyChip.textContent = statusText;
            historyChip.classList.remove('preparing', 'delivered', 'cancelled');
            historyChip.classList.add(statusText.toLowerCase());
        }

        function updateBannerStatus(statusText) {
            if (statusLabel) {
                statusLabel.textContent = statusText;
            }
            if (statusBtn) {
                statusBtn.classList.remove('delivered', 'cancelled');
                const lower = statusText.toLowerCase();
                if (lower === 'delivered') {
                    statusBtn.classList.add('delivered');
                } else if (lower === 'cancelled') {
                    statusBtn.classList.add('cancelled');
                }
            }
        }

        function disableActionButtons() {
            [doneBtn, cancelBtn].forEach((btn) => {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                }
            });
        }

        function handleOrderStatus(urlTemplate, successStatus, successToast, failureToast) {
            const orderId = orderBanner ? orderBanner.dataset.orderId : null;
            if (!orderId) {
                showToast(failureToast);
                return;
            }

            fetch(urlTemplate.replace('0', orderId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(async (response) => {
                const data = await response.json();
                return { ok: response.ok, data };
            })
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    updateBannerStatus(successStatus);
                    updateHistoryChip(orderId, successStatus);
                    disableActionButtons();
                    showToast(successToast);
                } else {
                    showToast(failureToast);
                }
            })
            .catch(() => showToast(failureToast));
        }

        if (doneBtn && statusLabel) {
            doneBtn.addEventListener('click', () => {
                handleOrderStatus(
                    `{{ url_for('main.mark_order_delivered', order_id=0) }}`,
                    'Delivered',
                    'Your bread has been delivered!',
                    'Unable to update delivery status.'
                );
            });
        }

        if (cancelBtn && statusLabel) {
            cancelBtn.addEventListener('click', () => {
                handleOrderStatus(
                    `{{ url_for('main.cancel_order', order_id=0) }}`,
                    'Cancelled',
                    'Your order has been cancelled.',
                    'Unable to cancel order.'
                );
            });
        }
    });
</script>
{% endblock %}