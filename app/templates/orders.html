{% extends "base.html" %}

{% block title %}Orders & Deliveries{% endblock %}

{% block extra_css %}
<style>
.orders-wrapper { max-width: 1100px; margin: 4rem auto; padding: 0 1rem; }
.orders-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
.orders-header h1 { font-size:2.5rem; }
.orders-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1.5rem; }
.orders-card { background:white; border-radius:18px; padding:1.5rem; box-shadow:0 25px 55px rgba(10,21,48,0.1); position:relative; transition: transform 0.3s; }
.orders-card:hover { transform: translateY(-4px); }
.orders-card h2 { font-size:1.3rem; margin-bottom:0.8rem; }
.status-chip { display:inline-flex; padding:0.4rem 0.95rem; border-radius:999px; font-size:0.85rem; font-weight:600; }
.status-chip.preparing { background:rgba(14,116,144,0.12); color:#0e7490; }
.status-chip.delivered { background:rgba(34,197,94,0.12); color:#15803d; }
.btn-done { width:100%; border:none; border-radius:12px; padding:0.85rem; font-weight:600; cursor:pointer; margin-top:0.8rem; background:linear-gradient(135deg,#fbbf24,#ffd166); color:#0a1530; transition: transform 0.2s, box-shadow 0.2s; }
.btn-done:hover { transform:translateY(-1px); box-shadow:0 18px 30px rgba(251,191,36,0.4); }
.section-title { font-size:1.4rem; margin:2rem 0 1rem; }
.history-table { width:100%; border-collapse:collapse; border-radius:20px; overflow:hidden; box-shadow:0 12px 30px rgba(10,21,48,0.08); }
.history-table th, .history-table td { padding:1rem; text-align:left; background:white; }
.history-table th { background:#0a1530; color:#fbbf24; text-transform:uppercase; font-size:0.85rem; }
.history-table tr + tr td { border-top:1px solid #f3f4f6; }
.btn-remove { background:#ef4444; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:600; transition:all 0.2s; }
.btn-remove:hover { background:#dc2626; transform:translateY(-1px); box-shadow:0 4px 8px rgba(239,68,68,0.3); }
.btn-remove:disabled { opacity:0.5; cursor:not-allowed; }
.toast-notification { position:fixed; top:20px; right:20px; background:#0a1530; color:#fbbf24; padding:1rem 1.5rem; border-radius:12px; box-shadow:0 15px 35px rgba(0,0,0,0.3); z-index:9999; opacity:0; transform:translateX(100px); transition:all 0.3s ease; font-weight:600; }
.toast-notification.show { opacity:1; transform:translateX(0); }
.toast-notification.success { background:#22c55e; color:white; }
.toast-notification.error { background:#ef4444; color:white; }
</style>
{% endblock %}

{% block content %}
<div class="orders-wrapper">
    <div class="orders-header">
        <h1>Deliveries & History</h1>
        <a href="{{ url_for('main.checkout') }}">Back to checkout</a>
    </div>

    <h2 class="section-title">Active Deliveries</h2>
    {% if order_history %}
        {% set pending_orders = order_history | selectattr('status','ne','Delivered') | list %}
    {% else %}
        {% set pending_orders = [] %}
    {% endif %}
    {% if pending_orders %}
    <div class="orders-grid">
        {% for order in pending_orders %}
        <div class="orders-card" data-order-id="{{ order.id }}">
            <div class="status-chip {{ order.status|lower }}">
                {{ order.status }}
            </div>
            <h2>Order #{{ "%04d"|format(order.id) }}</h2>
            <p>{{ order.customer }} • {{ order.payment_method }}</p>
            <ul>
                {% if order['items'] %}
                    {% for item in order['items'] %}
                    <li>{{ item.quantity }} × {{ item.name }}</li>
                    {% endfor %}
                {% endif %}
            </ul>
            <p><strong>Total:</strong> ${{ "%.2f"|format(order.total) }}</p>
            <button class="btn-done mark-done-btn">Mark as Delivered</button>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No active deliveries.</p>
    {% endif %}

    <h2 class="section-title">Full Payment History</h2>
    {% if order_history %}
    <table class="history-table">
        <thead>
            <tr><th>Order</th><th>Placed</th><th>Payment</th><th>Total</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody>
            {% for order in order_history %}
            <tr data-order-id="{{ order.id }}">
                <td>#{{ "%04d"|format(order.id) }}</td>
                <td>{{ order.placed_at }}</td>
                <td>{{ order.payment_method }}</td>
                <td>${{ "%.2f"|format(order.total) }}</td>
                <td><span class="status-chip {{ order.status|lower }}">{{ order.status }}</span></td>
                <td><button class="btn-remove remove-order-btn" data-order-id="{{ order.id }}">Remove</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toast notification
function showToast(message, type='info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(()=>toast.classList.add('show'),10);
    setTimeout(()=>{
        toast.classList.remove('show');
        setTimeout(()=>toast.remove(),300);
    },3000);
}

document.addEventListener('DOMContentLoaded',function(){
    // Use placeholders for safe replacement
    const markDeliveredUrl = "{{ url_for('main.mark_order_delivered', order_id='ORDER_ID') }}";
    const removeOrderUrl = "{{ url_for('main.remove_order', order_id='ORDER_ID') }}";
    const csrfToken = "{{ csrf_token() if csrf_token else '' }}";

    // Mark as delivered
    document.querySelectorAll('.mark-done-btn').forEach(btn=>{
        btn.addEventListener('click',function(){
            const card = btn.closest('.orders-card');
            const orderId = card.dataset.orderId;
            if(!orderId) return;

            btn.disabled=true; btn.textContent='Completing...'; btn.style.opacity='0.7';

            fetch(markDeliveredUrl.replace('ORDER_ID',orderId),{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-Requested-With':'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(res=>res.json())
            .then(data=>{
                if(data.success){
                    showToast('Order marked as delivered!', 'success');

                    const chip = card.querySelector('.status-chip');
                    if(chip){ chip.textContent='Delivered'; chip.classList.remove('preparing'); chip.classList.add('delivered'); }

                    btn.textContent='Delivered ✓'; btn.style.background='linear-gradient(135deg,#22c55e,#16a34a)';
                    btn.style.color='white'; btn.style.cursor='default'; btn.disabled=true;

                    // Update history table status
                    const historyRow = document.querySelector(`.history-table tr[data-order-id="${orderId}"]`);
                    if(historyRow){
                        const historyChip = historyRow.querySelector('.status-chip');
                        if(historyChip){ historyChip.textContent='Delivered'; historyChip.classList.remove('preparing'); historyChip.classList.add('delivered'); }
                    }

                    // Fade out and remove card
                    setTimeout(()=>{
                        card.style.transition='opacity 0.5s, transform 0.5s';
                        card.style.opacity='0'; card.style.transform='translateY(-20px)';
                        setTimeout(()=>{
                            card.remove();
                            if(document.querySelectorAll('.orders-card').length===0){
                                const grid = document.querySelector('.orders-grid');
                                if(grid){
                                    const emptyMsg = document.createElement('p');
                                    emptyMsg.textContent='No active deliveries.';
                                    emptyMsg.style.marginTop='1rem';
                                    emptyMsg.style.padding='2rem';
                                    emptyMsg.style.textAlign='center';
                                    emptyMsg.style.color='#666';
                                    grid.parentElement.appendChild(emptyMsg);
                                    grid.remove();
                                }
                            }
                        },500);
                    },1000);
                } else showToast(data.message,'error');
            })
            .catch(err=>{ console.error(err); showToast('Failed to update order status','error'); btn.disabled=false; btn.textContent='Mark as Delivered'; btn.style.opacity='1'; });
        });
    });

    // Remove order
    document.querySelectorAll('.remove-order-btn').forEach(btn=>{
        btn.addEventListener('click',function(){
            const orderId = btn.dataset.orderId;
            const row = btn.closest('tr');
            if(!orderId) return;

            if(!confirm(`Remove Order #${orderId.toString().padStart(4,'0')} from history?`)) return;

            btn.disabled=true; btn.textContent='Removing...'; btn.style.opacity='0.7';

            fetch(removeOrderUrl.replace('ORDER_ID',orderId),{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-Requested-With':'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(res=>res.json())
            .then(data=>{
                if(data.success){
                    showToast('Order removed from payment history!','success');
                    row.style.transition='opacity 0.3s, transform 0.3s';
                    row.style.opacity='0'; row.style.transform='translateX(-20px)';
                    setTimeout(()=>{
                        row.remove();
                        const tbody = document.querySelector('.history-table tbody');
                        if(tbody && tbody.children.length===0){
                            const table = document.querySelector('.history-table');
                            const emptyMsg = document.createElement('p');
                            emptyMsg.textContent='No payment history. Your future orders will appear here.';
                            emptyMsg.style.marginTop='1rem'; emptyMsg.style.padding='2rem'; emptyMsg.style.textAlign='center'; emptyMsg.style.color='#666';
                            table.parentElement.appendChild(emptyMsg);
                            table.remove();
                        }
                    },300);
                } else throw new Error(data.message || 'Failed to remove order');
            })
            .catch(err=>{ console.error(err); showToast('Failed to remove order','error'); btn.disabled=false; btn.textContent='Remove'; btn.style.opacity='1'; });
        });
    });
});
</script>
{% endblock %}
